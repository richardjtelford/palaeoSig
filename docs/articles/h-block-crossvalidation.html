<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>H-block cross-validation • palaeoSig</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="H-block cross-validation">
<meta property="og:description" content="palaeoSig">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">palaeoSig</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.1-3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/h-block-crossvalidation.html">H-block cross-validation</a>
    </li>
    <li>
      <a href="../articles/randomTF-spatial.html">randomTF on spatially structured environments</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/richardjtelford/palaeoSig/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>H-block cross-validation</h1>
                        <h4 data-toc-skip class="author">Mathias
Trachsel and Richard J Telford</h4>
            
            <h4 data-toc-skip class="date">2023-03-09</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/richardjtelford/palaeoSig/blob/HEAD/vignettes/h-block-crossvalidation.Rmd" class="external-link"><code>vignettes/h-block-crossvalidation.Rmd</code></a></small>
      <div class="hidden name"><code>h-block-crossvalidation.Rmd</code></div>

    </div>

    
    
<p>Spatial autocorrelation can severely bias transfer function
performance estimates. Telford and Birks (2009) suggested
<em>h</em>-block cross-validation as a means of obtaining unbiased
transfer function estimates. The problem is to estimate the optimal
value of <em>h</em>: too small and the performance estimates are still
over-optimistic, too large and the performance estimates are
pessimistic. Trachsel and Telford (2015) presented three methods to
estimate <em>h</em>:</p>
<ol style="list-style-type: decimal">
<li>the performance of a transfer function on a spatially independent
test set</li>
<li>the autocorrelation in residuals of a weighted averaging transfer
function</li>
<li>Comparing the variance explained of a transfer function trained on
random environmental data with similar spatial structure as the
environmental data of influence with the correlation between the
simulated data and the environmental data of influence.</li>
</ol>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/richardjtelford/palaeoSig" class="external-link">palaeoSig</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.staff.ncl.ac.uk/stephen.juggins/" class="external-link">rioja</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/gstat/" class="external-link">gstat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span> <span class="co"># for reproducibility </span></span></code></pre></div>
<div class="section level2">
<h2 id="spatially-independent-test-set">1. Spatially independent test set<a class="anchor" aria-label="anchor" href="#spatially-independent-test-set"></a>
</h2>
<p>We use the foraminifera dataset by <a href="https://doi.pangaea.de/10.1594/PANGAEA.227322" class="external-link">Kucera et
al. (2005)</a>. We split the dataset into two parts, a North Atlantic
(NA) dataset (north of 3°N) and a South Atlantic (SA) data set (south of
3°S). We use the NA dataset as training set and the SA dataset as
spatially independent test set.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">Atlantic</span><span class="op">)</span></span>
<span><span class="va">meta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Core"</span>, <span class="st">"Latitude"</span>, <span class="st">"Longitude"</span>, <span class="st">"summ50"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># N Atlantic</span></span>
<span><span class="va">N_Atlantic</span> <span class="op">&lt;-</span> <span class="va">Atlantic</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Latitude</span> <span class="op">&gt;</span> <span class="fl">3</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_sample</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">300</span><span class="op">)</span> <span class="co"># subsample for speed</span></span>
<span><span class="va">N_Atlantic_meta</span> <span class="op">&lt;-</span> <span class="va">N_Atlantic</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/one_of.html" class="external-link">one_of</a></span><span class="op">(</span><span class="va">meta</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># to keep rdist.earth happy</span></span>
<span><span class="va">N_Atlantic</span> <span class="op">&lt;-</span> <span class="va">N_Atlantic</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/one_of.html" class="external-link">one_of</a></span><span class="op">(</span><span class="va">meta</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S Atlantic</span></span>
<span><span class="va">S_Atlantic</span> <span class="op">&lt;-</span> <span class="va">Atlantic</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Latitude</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">S_Atlantic_meta</span> <span class="op">&lt;-</span> <span class="va">S_Atlantic</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/one_of.html" class="external-link">one_of</a></span><span class="op">(</span><span class="va">meta</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">S_Atlantic</span> <span class="op">&lt;-</span> <span class="va">S_Atlantic</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/one_of.html" class="external-link">one_of</a></span><span class="op">(</span><span class="va">meta</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## convert N_Atlatic_meta to an sf object</span></span>
<span></span>
<span><span class="va">N_Atlantic_meta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">N_Atlantic_meta</span>,</span>
<span>  coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Longitude"</span>, <span class="st">"Latitude"</span><span class="op">)</span>,</span>
<span>  crs <span class="op">=</span> <span class="fl">4326</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># calculating distances among the sampled points in the</span></span>
<span><span class="co"># North Atlantic foraminifera data set</span></span>
<span><span class="va">geodist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html" class="external-link">st_distance</a></span><span class="op">(</span><span class="va">N_Atlantic_meta</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/units/man/units.html" class="external-link">set_units</a></span><span class="op">(</span><span class="st">"km"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/units/man/units.html" class="external-link">set_units</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># values of h for which h-block cross-validation is calculated</span></span>
<span><span class="va">threshs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">300</span>, <span class="fl">600</span>, <span class="fl">900</span>, <span class="fl">1200</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># h-block cross-validation of the NA foraminifera dataset for</span></span>
<span><span class="co"># different values of h</span></span>
<span><span class="va">res_h</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">threshs</span>, <span class="kw">function</span><span class="op">(</span><span class="va">h</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rioja/man/MAT.html" class="external-link">MAT</a></span><span class="op">(</span><span class="va">N_Atlantic</span>, <span class="va">N_Atlantic_meta</span><span class="op">$</span><span class="va">summ50</span>, k <span class="op">=</span> <span class="fl">5</span>, lean <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rioja/man/PTF.html" class="external-link">crossval</a></span><span class="op">(</span><span class="va">mod</span>, cv.method <span class="op">=</span> <span class="st">"h-block"</span>, h.dist <span class="op">=</span> <span class="va">geodist</span>, h.cutoff <span class="op">=</span> <span class="va">h</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    h <span class="op">=</span> <span class="va">h</span>,</span>
<span>    RMSE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/rioja/man/PTF.html" class="external-link">performance</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span><span class="op">$</span><span class="va">crossval</span><span class="op">[</span><span class="st">"N05"</span>, <span class="st">"RMSE"</span><span class="op">]</span>,</span>
<span>    R2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/rioja/man/PTF.html" class="external-link">performance</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span><span class="op">$</span><span class="va">crossval</span><span class="op">[</span><span class="st">"N05"</span>, <span class="st">"R2"</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/list_c.html" class="external-link">list_rbind</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>First, we estimate the performance of the North Atlantic (NA)
foraminifera training set when applied to the spatially independent data
set from the South Atlantic (SA), which in our case contains the samples
used by Kucera et al. (2005) that are situated south of 3°S.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Leave-one-out cross-validated RMSEP using MAT with k = 5</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">res_h</span><span class="op">[</span><span class="fl">1</span>, <span class="st">"RMSE"</span><span class="op">]</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co"># Predicting the South Atlantic test set</span></span>
<span><span class="va">mod_NA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rioja/man/MAT.html" class="external-link">MAT</a></span><span class="op">(</span><span class="va">N_Atlantic</span>, <span class="va">N_Atlantic_meta</span><span class="op">$</span><span class="va">summ50</span>, k <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">pred_SA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">mod_NA</span>, newdata <span class="op">=</span> <span class="va">S_Atlantic</span><span class="op">)</span><span class="op">$</span><span class="va">fit</span></span>
<span><span class="co"># Determining RMSEP of the SA test set</span></span>
<span><span class="va">rmse_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">pred_SA</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">S_Atlantic_meta</span><span class="op">$</span><span class="va">summ50</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># RMSEP of the SA test set using MAT with k = 5</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">rmse_mat</span>, <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>The RMSEP of the NA training set is 1.28 while the RMSEP of the
spatially independent SA data set is somewhat larger: 2.1. This is
indicative of spatial autocorrelation. We have to find the the removal
distance <em>h</em> at which the <em>h</em>-block cross-validated RMSEP
and the RMSEP of the SA test set are similar.</p>
<div class="figure">
<img src="h-block-crossvalidation_files/figure-html/unnamed-chunk-4-1.png" alt="Figure 1: Root mean square error of prediction (RMSEP) as a function of removal distance h. Dashed horizontal line indicates RMSEP found on a spatially independent test set." width="700"><p class="caption">
Figure 1: Root mean square error of prediction (RMSEP) as a function of
removal distance h. Dashed horizontal line indicates RMSEP found on a
spatially independent test set.
</p>
</div>
<p>Using linear interpolation, an <em>h</em>-block distance of 761 km
gives a cross-validated RMSEP equivalent to the the RMSEP of a spatially
independent test set.</p>
</div>
<div class="section level2">
<h2 id="variogram-range">2. Variogram range<a class="anchor" aria-label="anchor" href="#variogram-range"></a>
</h2>
<p>The second method proposed in Trachsel and Telford is to fit a
variogram to detrended residuals of a weighted average model and use the
range of the variogram as <em>h</em>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># WA model</span></span>
<span><span class="va">modwa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rioja/man/PTF.html" class="external-link">crossval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/rioja/man/WA.html" class="external-link">WA</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">N_Atlantic</span><span class="op">)</span>, <span class="va">N_Atlantic_meta</span><span class="op">$</span><span class="va">summ50</span>, mono <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># residuals of the WA model</span></span>
<span><span class="va">wa_resid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">modwa</span>, cv <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># detrend to remove edge effects (loess with span = 0.1)</span></span>
<span><span class="va">detrended_resid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">resid</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/loess.html" class="external-link">loess</a></span><span class="op">(</span><span class="va">wa_resid</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">~</span> <span class="va">N_Atlantic_meta</span><span class="op">$</span><span class="va">summ50</span>,</span>
<span>  span <span class="op">=</span> <span class="fl">0.1</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># variogram of the detrended residuals of the WA model</span></span>
<span><span class="va">v</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gstat/man/variogram.html" class="external-link">variogram</a></span><span class="op">(</span><span class="va">detrended_resid</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">N_Atlantic_meta</span><span class="op">)</span></span>
<span><span class="co"># Fitting a spherical variogram (partial sill, range and nugget are</span></span>
<span><span class="co"># approximately estimated from the empirical variogram)</span></span>
<span><span class="va">vm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gstat/man/fit.variogram.html" class="external-link">fit.variogram</a></span><span class="op">(</span><span class="va">v</span>, <span class="fu"><a href="https://rdrr.io/pkg/gstat/man/vgm.html" class="external-link">vgm</a></span><span class="op">(</span>psill <span class="op">=</span> <span class="fl">2</span>, <span class="st">"Sph"</span>, range <span class="op">=</span> <span class="fl">1500</span>, nugget <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">v</span>, <span class="va">vm</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="h-block-crossvalidation_files/figure-html/unnamed-chunk-5-1.png" alt="Figure 2: Semi-variogram fitted to detrended residuals of a weighted averaging model." width="700"><p class="caption">
Figure 2: Semi-variogram fitted to detrended residuals of a weighted
averaging model.
</p>
</div>
<p>The estimated range of a spherical variogram model fitted to the
detrended residual of a WA model is 794 km.</p>
</div>
<div class="section level2">
<h2 id="variance-explained">3. Variance explained<a class="anchor" aria-label="anchor" href="#variance-explained"></a>
</h2>
<p>The third method suggested is based on simulated environmental
variables with the same spatial structure as the environmental variable
of interest. The transfer function performance (r<sup>2</sup>) of the
simulated variable is compared to the r<sup>2</sup> between the
environmental variable of interest and the simulated variables. The
optimal value for <em>h</em> is the value that minimises the difference
these two r<sup>2</sup>.</p>
<p>To simulate the environmental variables of interest, we first have to
estimate their spatial structure with a variogram and then use kriging
with the variogram to simulate environmental variables with same spatial
structure as the observed variable.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Estimate the variogram model for the environmental variable of interest</span></span>
<span><span class="va">ve</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gstat/man/variogram.html" class="external-link">variogram</a></span><span class="op">(</span><span class="va">summ50</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">N_Atlantic_meta</span><span class="op">)</span></span>
<span><span class="va">vem</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gstat/man/fit.variogram.html" class="external-link">fit.variogram</a></span><span class="op">(</span><span class="va">ve</span>, <span class="fu"><a href="https://rdrr.io/pkg/gstat/man/vgm.html" class="external-link">vgm</a></span><span class="op">(</span><span class="fl">40</span>, <span class="st">"Mat"</span>, <span class="fl">5000</span>, <span class="fl">.1</span>, kappa <span class="op">=</span> <span class="fl">1.8</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ve</span>, <span class="va">vem</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="h-block-crossvalidation_files/figure-html/unnamed-chunk-6-1.png" alt="Figure 3: Semi-variogram model (Matérn class) fitted to the North Atlantic summer sea temperature at 50 m depth." width="700"><p class="caption">
Figure 3: Semi-variogram model (Matérn class) fitted to the North
Atlantic summer sea temperature at 50 m depth.
</p>
</div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Simulating environmental variables</span></span>
<span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gstat/man/krige.html" class="external-link">krige</a></span><span class="op">(</span><span class="va">sim</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  locations <span class="op">=</span> <span class="va">N_Atlantic_meta</span>,</span>
<span>  dummy <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  nsim <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  beta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">N_Atlantic_meta</span><span class="op">$</span><span class="va">summ50</span><span class="op">)</span>,</span>
<span>  model <span class="op">=</span> <span class="va">vem</span>,</span>
<span>  newdata <span class="op">=</span> <span class="va">N_Atlantic_meta</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [using unconditional Gaussian simulation]</span></span>
<span></span>
<span><span class="co"># convert back to a regular data.frame</span></span>
<span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="va">sim</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Running a MAT models for each simulation at each value of <em>h</em>
would be very slow, but since the same analogues would be chosen for any
environmental variable, we can make a much faster version of MAT.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Function for h-block cross-validating several simulations at a time</span></span>
<span><span class="va">mat_h1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span>, <span class="va">x</span>, <span class="va">noanalogues</span>, <span class="va">geodist</span>, <span class="va">thresh</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">y</span>, <span class="st">"dist"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">is.data.frame</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">||</span> <span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/dist.html" class="external-link">dist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="co"># squared chord distance</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">Inf</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">geodist</span>, <span class="st">"dist"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">geodist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">geodist</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">exneigh</span> <span class="op">&lt;-</span> <span class="va">geodist</span><span class="op">[</span><span class="va">n</span>, <span class="op">]</span> <span class="op">&gt;=</span> <span class="va">thresh</span></span>
<span>    <span class="va">x2</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="va">exneigh</span>, <span class="op">]</span></span>
<span>    <span class="va">y2</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">n</span>, <span class="op">]</span><span class="op">[</span><span class="va">exneigh</span><span class="op">]</span></span>
<span>    <span class="va">analogues</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rank.html" class="external-link">rank</a></span><span class="op">(</span><span class="va">y2</span>, ties.method <span class="op">=</span> <span class="st">"random"</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="va">noanalogues</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">x2</span><span class="op">[</span><span class="va">analogues</span>, <span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="co"># h-block cross-validation of the simulated variables</span></span>
<span><span class="va">simhr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">threshs</span>, <span class="kw">function</span><span class="op">(</span><span class="va">h</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">hn</span> <span class="op">&lt;-</span> <span class="fu">mat_h1</span><span class="op">(</span><span class="va">N_Atlantic</span>, <span class="va">sim</span>, noanalogues <span class="op">=</span> <span class="fl">5</span>, geodist <span class="op">=</span> <span class="va">geodist</span>, thresh <span class="op">=</span> <span class="va">h</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">hn</span><span class="op">)</span>, <span class="va">sim</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimating squared correlation between environmental variable of interest and</span></span>
<span><span class="co"># simulated variables</span></span>
<span><span class="va">sim_obs_r2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">sim</span>, <span class="va">cor</span>, <span class="va">N_Atlantic_meta</span><span class="op">$</span><span class="va">summ50</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="co"># Calculating sum of squares between the two squared correlations</span></span>
<span><span class="va">so_squares</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">simhr</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">sim_obs_r2</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simhr</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html" class="external-link">set_names</a></span><span class="op">(</span><span class="va">threshs</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>sim_obs_r2 <span class="op">=</span> <span class="va">sim_obs_r2</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="va">sim_obs_r2</span>, names_to <span class="op">=</span> <span class="st">"h"</span>, values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">h</span>, levels <span class="op">=</span> <span class="va">threshs</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">sim_obs_r2</span>, y <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">h</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Simulated-observed environmental r²"</span>, y <span class="op">=</span> <span class="st">"Transfer function r²"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="h-block-crossvalidation_files/figure-html/unnamed-chunk-8-1.png" alt="Figure 5: Scatterplot of squared correlation coefficients between simulated variables and the environmental variable of interest and transfer function r^2^." width="700"><p class="caption">
Figure 5: Scatterplot of squared correlation coefficients between
simulated variables and the environmental variable of interest and
transfer function r<sup>2</sup>.
</p>
</div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="va">threshs</span>, <span class="va">so_squares</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">threshs</span>, y <span class="op">=</span> <span class="va">so_squares</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"h km"</span>, y <span class="op">=</span> <span class="st">"Sum of squares"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="h-block-crossvalidation_files/figure-html/unnamed-chunk-9-1.png" alt="Figure 6: Relationship between the sum of squares between the two r^2^ as function of distance *h*." width="700"><p class="caption">
Figure 6: Relationship between the sum of squares between the two
r<sup>2</sup> as function of distance <em>h</em>.
</p>
</div>
<p>Following the rule described in Trachsel and Telford the value of
<em>h</em> is estimated as <em>h</em> = 900 km.</p>
<p>Hence the three methods proposed result in similar values of
<em>h</em>: <em>h</em> = 761 km for the spatially independent test set,
<em>h</em> = 794 km for the variogram range method and <em>h</em> = 900
km for the variance explained method.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Kucera, M., Weinelt, M., Kiefer, T., Pflaumann, U., Hayes, A.,
Weinelt, M., Chen, M.-T., Mix, A.C., Barrows, T.T., Cortijo, E., Duprat,
J., Juggins, S., Waelbroeck, C. 2005. Reconstruction of the glacial
Atlantic and Pacific sea-surface temperatures from assemblages of
planktonic foraminifera: multi-technique approach based on
geographically constrained calibration datasets. <em>Quaternary Science
Reviews</em> 24, 951-998 <a href="https://doi.org/10.1016/j.quascirev.2004.07.014" class="external-link">doi:10.1016/j.quascirev.2004.07.014</a>.</p>
<p>Telford, R.J., Birks, H.J.B. 2009. Evaluation of transfer functions
in spatially structured environments. <em>Quaternary Science
Reviews</em> 28, 1309-1316 <a href="https://doi.org/10.1016/j.quascirev.2008.12.020" class="external-link">doi:10.1016/j.quascirev.2008.12.020</a>.</p>
<p>Trachsel, M., Telford, R.J. (2016). Technical note: Estimating
unbiased transfer function performances in spatially structured
environments. submitted to: <em>Climate of the Past</em> 12, 1215-1223
<a href="https://doi.org/10.5194/cp-12-1215-2016" class="external-link">doi:10.5194/cp-12-1215-2016</a></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Richard Telford.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
