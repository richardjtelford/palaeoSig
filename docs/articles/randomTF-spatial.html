<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>randomTF on spatially structured environments • palaeoSig</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="randomTF on spatially structured environments">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">palaeoSig</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.1-4</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/h-block-crossvalidation.html">H-block cross-validation</a></li>
    <li><a class="dropdown-item" href="../articles/randomTF-spatial.html">randomTF on spatially structured environments</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/richardjtelford/palaeoSig/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>randomTF on spatially structured environments</h1>
                        <h4 data-toc-skip class="author">Richard J
Telford</h4>
            
            <h4 data-toc-skip class="date">2025-07-28</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/richardjtelford/palaeoSig/blob/HEAD/vignettes/randomTF-spatial.Rmd" class="external-link"><code>vignettes/randomTF-spatial.Rmd</code></a></small>
      <div class="d-none name"><code>randomTF-spatial.Rmd</code></div>
    </div>

    
    
<p>Spatial autocorrelation can severely bias transfer function
performance estimates. If can also bias reconstruction significance
tests, but I suspect the bias is not as severe.</p>
<p>This vignette show how to use the <code>autosim</code> argument to
<code><a href="../reference/randomTF.html">randomTF()</a></code> to use an autocorrelated simulated environmental
variables, instead of the default uniformly distributed independent
environmental variables, to make the reference distribution.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://richardjtelford.github.io/palaeoSig/">palaeoSig</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.staff.ncl.ac.uk/stephen.juggins/" class="external-link">rioja</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/gstat/" class="external-link">gstat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span> <span class="co"># for reproducibility</span></span></code></pre></div>
<div class="section level2">
<h2 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h2>
<p>We use the foraminifera dataset by <a href="https://doi.pangaea.de/10.1594/PANGAEA.227322" class="external-link">Kucera et
al. (2005)</a>. We use some of the samples to represent a core.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">Atlantic</span><span class="op">)</span></span>
<span><span class="va">meta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Core"</span>, <span class="st">"Latitude"</span>, <span class="st">"Longitude"</span>, <span class="st">"summ50"</span><span class="op">)</span></span>
<span><span class="va">Atlantic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">Atlantic</span><span class="op">)</span> <span class="co"># prevents rowname warnings</span></span>
<span></span>
<span><span class="co"># pseudocore as no fossil foram data in palaeoSig</span></span>
<span><span class="va">fosn</span> <span class="op">&lt;-</span> <span class="va">Atlantic</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html" class="external-link">between</a></span><span class="op">(</span><span class="va">summ50</span>, <span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_sample</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># remaining samples as training set</span></span>
<span><span class="va">Atlantic</span> <span class="op">&lt;-</span> <span class="va">Atlantic</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html" class="external-link">anti_join</a></span><span class="op">(</span><span class="va">fosn</span>, by <span class="op">=</span> <span class="st">"Core"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_sample</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">300</span><span class="op">)</span> <span class="co"># random subset to speed analysis up</span></span>
<span></span>
<span><span class="va">Atlantic_meta</span> <span class="op">&lt;-</span> <span class="va">Atlantic</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/one_of.html" class="external-link">one_of</a></span><span class="op">(</span><span class="va">meta</span><span class="op">)</span><span class="op">)</span> <span class="co"># to keep rdist.earth happy</span></span>
<span><span class="va">Atlantic</span> <span class="op">&lt;-</span> <span class="va">Atlantic</span> <span class="op">|&gt;</span> <span class="co"># species</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/one_of.html" class="external-link">one_of</a></span><span class="op">(</span><span class="va">meta</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fos</span> <span class="op">&lt;-</span> <span class="va">fosn</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/one_of.html" class="external-link">one_of</a></span><span class="op">(</span><span class="va">meta</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="variogram">Variogram<a class="anchor" aria-label="anchor" href="#variogram"></a>
</h2>
<p>We need to convert the meta data into an <code>sf</code> object for
further calculation.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Atlantic_meta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">Atlantic_meta</span>,</span>
<span>  coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Longitude"</span>, <span class="st">"Latitude"</span><span class="op">)</span>,</span>
<span>  crs <span class="op">=</span> <span class="fl">4326</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Fitting the variogram is the hardest part. There are several types of
variogram model available, e.g. exponential “Exp”, spherical “Sph”,
gaussian “Gau” and Matérn “Mat”. These have different shapes. It is
important to find one that fits the data well.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Estimate the variogram model for the environmental variable of interest</span></span>
<span><span class="va">ve</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/gstat/reference/variogram.html" class="external-link">variogram</a></span><span class="op">(</span><span class="va">summ50</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">Atlantic_meta</span><span class="op">)</span></span>
<span><span class="va">vem</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/gstat/reference/fit.variogram.html" class="external-link">fit.variogram</a></span><span class="op">(</span></span>
<span>  object <span class="op">=</span> <span class="va">ve</span>,</span>
<span>  model <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/gstat/reference/vgm.html" class="external-link">vgm</a></span><span class="op">(</span><span class="fl">40</span>, <span class="st">"Mat"</span>, <span class="fl">5000</span>, <span class="fl">.1</span>, kappa <span class="op">=</span> <span class="fl">1.8</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ve</span>, <span class="va">vem</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="randomTF-spatial_files/figure-html/unnamed-chunk-3-1.png" alt="Figure 1: Semi-variogram model (Matérn class) fitted to the Atlantic summer sea temperature at 50 m depth." width="700"><p class="caption">
Figure 1: Semi-variogram model (Matérn class) fitted to the Atlantic
summer sea temperature at 50 m depth.
</p>
</div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vem</span></span>
<span><span class="co">#&gt;   model       psill    range kappa</span></span>
<span><span class="co">#&gt; 1   Nug   0.7358321    0.000   0.0</span></span>
<span><span class="co">#&gt; 2   Mat 185.3131517 3404.449   1.8</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="kriging">Kriging<a class="anchor" aria-label="anchor" href="#kriging"></a>
</h2>
<p>Now we can use <code><a href="https://r-spatial.github.io/gstat/reference/krige.html" class="external-link">gstat::krige</a></code> to do Gaussian unconditional
simulation and make simulated environmental fields with the same spatial
structure as the observed variable. This step is quite slow with large
datasets.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Simulating environmental variables</span></span>
<span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/gstat/reference/krige.html" class="external-link">krige</a></span><span class="op">(</span><span class="va">sim</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  locations <span class="op">=</span> <span class="va">Atlantic_meta</span>,</span>
<span>  dummy <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  nsim <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  beta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">Atlantic_meta</span><span class="op">$</span><span class="st">"summ50"</span><span class="op">)</span>,</span>
<span>  model <span class="op">=</span> <span class="va">vem</span>,</span>
<span>  newdata <span class="op">=</span> <span class="va">Atlantic_meta</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [using unconditional Gaussian simulation]</span></span>
<span></span>
<span><span class="co"># convert sf back to a regular data.frame</span></span>
<span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="va">sim</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Now we can run <code>randomTF</code> using the simulated
environmental variables.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rtf_auto</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/randomTF.html">randomTF</a></span><span class="op">(</span></span>
<span>  spp <span class="op">=</span> <span class="va">Atlantic</span>,</span>
<span>  env <span class="op">=</span> <span class="va">Atlantic_meta</span><span class="op">$</span><span class="va">summ50</span>,</span>
<span>  fos <span class="op">=</span> <span class="va">fos</span>,</span>
<span>  autosim <span class="op">=</span> <span class="va">sim</span>,</span>
<span>  fun <span class="op">=</span> <span class="va">MAT</span>,</span>
<span>  col <span class="op">=</span> <span class="st">"MAT.wm"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in Merge(object$y, newdata, split = TRUE): Some row names were changed</span></span>
<span><span class="co">#&gt; to avoid duplicates.</span></span>
<span><span class="co">#&gt; Warning in Merge(object$y, newdata, split = TRUE): Some row names were changed</span></span>
<span><span class="co">#&gt; to avoid duplicates.</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">rtf_auto</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="randomTF-spatial_files/figure-html/randomTF-auto-1.png" alt="Figure 2. Result of randomTF with an autocorrelated null model." width="700"><p class="caption">
Figure 2. Result of randomTF with an autocorrelated null model.
</p>
</div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rtf_ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/randomTF.html">randomTF</a></span><span class="op">(</span></span>
<span>  spp <span class="op">=</span> <span class="va">Atlantic</span>,</span>
<span>  env <span class="op">=</span> <span class="va">Atlantic_meta</span><span class="op">$</span><span class="va">summ50</span>,</span>
<span>  fos <span class="op">=</span> <span class="va">fos</span>,</span>
<span>  fun <span class="op">=</span> <span class="va">MAT</span>,</span>
<span>  col <span class="op">=</span> <span class="st">"MAT.wm"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in Merge(object$y, newdata, split = TRUE): Some row names were changed</span></span>
<span><span class="co">#&gt; to avoid duplicates.</span></span>
<span><span class="co">#&gt; Warning in Merge(object$y, newdata, split = TRUE): Some row names were changed</span></span>
<span><span class="co">#&gt; to avoid duplicates.</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">rtf_ind</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="randomTF-spatial_files/figure-html/randomTF-independent-1.png" alt="Figure 3. Result of randomTF with a spatially independent null model." width="700"><p class="caption">
Figure 3. Result of randomTF with a spatially independent null model.
</p>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Kucera, M., Weinelt, M., Kiefer, T., Pflaumann, U., Hayes, A.,
Weinelt, M., Chen, M.-T., Mix, A.C., Barrows, T.T., Cortijo, E., Duprat,
J., Juggins, S., Waelbroeck, C. 2005. Reconstruction of the glacial
Atlantic and Pacific sea-surface temperatures from assemblages of
planktonic foraminifera: multi-technique approach based on
geographically constrained calibration datasets. <em>Quaternary Science
Reviews</em> 24, 951-998 <a href="https://doi.org/10.1016/j.quascirev.2004.07.014" class="external-link">doi:10.1016/j.quascirev.2004.07.014</a>.</p>
<p>Telford, R.J., Birks, H.J.B. 2009. Evaluation of transfer functions
in spatially structured environments. <em>Quaternary Science
Reviews</em> 28, 1309-1316 <a href="https://doi.org/10.1016/j.quascirev.2008.12.020" class="external-link">doi:10.1016/j.quascirev.2008.12.020</a>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Richard Telford.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
